{% extends "explorer/variation.html" %}
{% load static from staticfiles %}
{% load explorer_extras %}

{% block filterjs %}
{{ block.super }}
<!-- initialize filter functions -->
<script type="text/javascript">
$(document).ready(function() {
	// Initialize select2 fields
	$('#id_isotypes').select2({width: "100%", allowClear: true, placeholder: "Select isotype(s)"});
	$('#id_positions').select2({width: "100%", allowClear: true, placeholder: "Select position(s)"});
})
</script>
{% endblock %}


{% block plotjs %}
{{ block.super }}
<!-- send valid queries to api -->
<script type="text/javascript">
d3.json('{% url "explorer:distribution" clade_txids=clade_groups|clade_groups_to_url_string isotypes=isotypes|list_to_url_string positions=positions|list_to_url_string %}', function(plot_data) {
  d3.select('#distribution-area .loading-overlay').style('display', 'none');
  if ("server_error" in plot_data) d3.select('#distribution-area').text(plot_data['server_error'])
	else {
		draw_distribution(plot_data);

		// intialize download onclicks
		$('#distribution-download-pdf').click(function() { download_pdf('distribution'); });
		$('#distribution-download-json').click(function() { download_json(plot_data); });
	}
})
</script>
{% endblock %}



{% block filter %}

{% if clade_formset|haserrors:'' or form.errors %}
<div class='alert alert-danger'>
	The following errors were found:<br>
	{% if clade_formset|haserrors:'' %}
		{% for error in clade_formset.formset_wide_errors %}
			<li>{{ error|escape }}</li>
		{% endfor %}
		{% for dict in clade_formset.errors %}
	  {% for errorlist in dict.values %}
	  	<!-- suppress errors for dummy form -->
	  	{% if errorlist and forloop.parentloop.counter0 != 0 %}
	  	<ul>
	  		{% for error in errorlist %}
				<li>{{ error|safe }}</li>
				{% endfor %}
			</ul>
			{% endif %}
	  {% endfor %}
		{% endfor %}
	{% endif %}

	{% if form.non_field_errors %}
		{% for error in form.non_field_errors %}
			<li>Form error: {{ error|escape }}</li>
		{% endfor %}
	{% endif %}
	{% for field in form %}
		{% for error in field.errors %}
			<li>Error in field {{ field.name }}: {{ error|escape }}</li>
		{% endfor %}
	{% endfor %}
</div>
{% endif %}

<div class='p-3'>
	<form id='data-select-form' action='{% url "explorer:variation_distribution" %}' method="POST">
	{% csrf_token %}
	<div class='row vertical-align clade-select-bar'>
		<div class='col-md-2 p-3'>
			<h4>Select Clades</h4>
		</div>

		<div class='col-md-10 p-3'>
			{{ clade_formset.management_form }}
			{% for clade_group_form in clade_formset.forms %}
			{% if forloop.counter0 == 0 %}
			<!-- Dummy clade form row -->
			<div class='clade-form-row-dummy' style='display:none;'>
			{% else %}
			<div class='clade-form-row'>
			{% endif %}
				<div class="row">
					<div class="col-11">
						{% for field in clade_group_form.visible_fields %}
						<select class='form-control multiselect clade-select' multiple name="clade-{{ forloop.parentloop.counter0 }}-clade_group" id="id_clade-{{ forloop.parentloop.counter0 }}-clade_group" data-select2-id="id_clade-{{ forloop.parentloop.counter0 }}-clade_group">
							{% for choice in field.value %}
							<option value="{{ choice }}" selected >{{ choice|clade_lookup }}</option>
							{% endfor %}
						</select>
						{% endfor %}
					</div>
					<div class="col-1">
				  	{% if forloop.counter0 != 1 %}
						<button class="btn btn-sm btn-danger remove-clade-group">Delete</button>
				  	{% endif %}
					</div>
				</div>
			</div>
			{% endfor %}
			<div class='my-2'>
				<button class="btn btn-success add-clade-group">Add clade group</button>
			</div>
		</div>
	</div>


	<div class='row vertical-align select-bar data-select-bar'>
		<div class='col-md-2 p-3'>
			<h4>Select Focus</h4>
		</div>

		<div class='col-md-10 p-3'>
			{% for field in form.visible_fields %}
			<div class='my-2'>
					{{ field }}
			</div>
			{% endfor %}
			<div class='my-2'>
				<button class='btn btn-primary' type='submit'>Submit</button>
			</div>
		</div>
	</div>
  </form>
</div>
{% endblock %}


{% block table %}
<div class="data-select-table">
	<table class="table sticky-top">
		<thead>
			<tr>
				<th scope="col">Clade(s)</th>
				<th scope="col">Isotype(s)</th>
				<th scope="col">Position(s)</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{{ clade_group_names|clade_names_to_pretty_string|linebreaks }}</td>
				<td>{{ isotypes|list_to_pretty_string }}</td>
				<td>{{ positions|list_to_pretty_string }}</td>
			</tr>
		</tbody>
	</table>
</div>
{% endblock %}