{% extends "base.html" %}
{% load static from staticfiles %}
{% load explorer_extras %}
{% debug %}

{% block static %}
<link rel="stylesheet" href="{% static 'explorer/css/explorer.css' %}">
{% endblock %}

{% block title %}tRNAviz | Compare{% endblock %}

{% block filterjs %}
<script src='https://code.jquery.com/jquery-3.2.1.slim.min.js' integrity='sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN' crossorigin='anonymous'></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

<script>	
$(document).ready(function() {
	$('#clade-select-0').select2({width: "100%", allowClear: true, placeholder: "Select reference clade"});
	$('#isotype-select-0').select2({width: "100%", allowClear: true, placeholder: "Select reference isotype"});
	for (var i = 2, form_rows = $('.form-row'); i < form_rows.length + 2; i++) {
		$('#clade-select-' + i).select2({width: "100%", allowClear: true, placeholder: "Select clade"});
		$('#isotype-select-' + i).select2({width: "100%", allowClear: true, placeholder: "Select isotype"});
	}
})
</script>


<script type='text/javascript'>
var select2_placeholders = {'name': 'Group name (required)', 'clade': 'Select clade', 'isotype': 'Select isotype', 'fasta': 'Paste sequence in FASTA format (sequence characters in [AGCUT] only)'}
function deleteForm(btn) {
  var form_number = parseInt($('#id_form-TOTAL_FORMS').val());
  
  btn.closest('.form-row').remove();
  $('#id_form-TOTAL_FORMS').val(--form_number);
  // loop through all forms and update field numbering
  for (var i = 1, form_index = 3, form_rows = $('.form-row'); i < form_rows.length; i++, form_index++) {
    $(form_rows.get(i)).find(':input').each(function() {
    	if ($(this).hasClass('btn')) return true;
  		var old_number_regex = new RegExp('\\d+');
      var name = $(this).attr('name').replace(old_number_regex, form_index);
      var id = $(this).attr('id').replace(old_number_regex, form_index);
      $(this).attr({'name': name, 'id': id});
      if ($(this).attr('type') == "text") return true;
      // remove and rebind select2 for select fields
      $(this).select2("destroy");
      $(this).attr('data-select2-id', id);
      var field = name.split('-').pop()
      $(this).select2({width: "100%", allowClear: true, placeholder: select2_placeholders[field]});
    });
  }
}
$(document).on('click', '.add-form-row', function(e){
  e.preventDefault();
  var clade_select;
  var isotype_select;

  var addFormRow = function () {
  	var new_form = $('.form-row-dummy').clone(true).removeClass().addClass('form-row').css('display', 'block');
  	var form_index = $('#id_form-TOTAL_FORMS').val();
  	name_input = new_form.find('#name-input-1');
  	name_input.attr({'name': 'form-' + form_index + '-name', 'id': 'name-input-' + form_index}).val('');
	  clade_select = new_form.find('#clade-select-1');
	  clade_select.attr({'name': 'form-' + form_index + '-clade', 'id': 'clade-select-' + form_index}).val('');
	  isotype_select = new_form.find('#isotype-select-1')
	  isotype_select.attr({'name': 'form-' + form_index + '-isotype', 'id': 'isotype-select-' + form_index}).val('');

	  $('#id_form-TOTAL_FORMS').val(++form_index);
	  $('.form-row:last').after(new_form)
  }

  $.when(addFormRow()).done( function() {
  	clade_select.select2({width: "100%", allowClear: true, placeholder: "Select clade"});
  	isotype_select.select2({width: "100%", allowClear: true, placeholder: "Select isotype"});
  });
	
});

$(document).on('click', '.remove-form-row', function(e){
  e.preventDefault();
  deleteForm($(this));
  return false;
});
</script>
{% endblock %}


{% block filter %}
<div class='p-3'>
	<form id='data-select-form' action='' method="POST">
		{% csrf_token %}


		{{ formset.management_form }}
		{% for form in formset.forms %}
		{% if forloop.counter == 1 %}
		<div class='row vertical-align select-bar reference-select-bar'>
			<div class='col-md-2 p-3'>
				<h4>Reference</h4>
			</div>
			<div class='col-md-10 p-3'>
		{% elif forloop.counter == 2 %}
		<div class='row vertical-align select-bar data-select-bar'>
			<div class='col-md-2 p-3'>
				<h4>Selections</h4>
			</div>
			<div class='col-md-10 p-3'>
		{% endif %}
				{% if forloop.counter == 1 %}
				<div>
				{% elif forloop.counter == 2 %}
				<div class='form-row-dummy' style="display: none;">
					<hr class="col-md-10">
				{% elif forloop.counter > 2 %}
				<div class='form-row' style='display: block;'>
				{% endif %}
				{% if forloop.counter > 1 %}
					<div class='my-2'>
						<input class="form-control" type="text" name="form-{{ forloop.counter0 }}-name" id="name-input-{{ forloop.counter0 }}" placeholder="Group name" value="{{ form.name.value|default_if_none:'' }}">
					</div>
				{% endif %}
					<div class='my-2 db-select'>
						<select class='form-control multiselect' name="form-{{ forloop.counter0 }}-clade" id="clade-select-{{ forloop.counter0 }}">
							<option></option>
							{% for clade in form.clade.field.choices %}
							{% if form.clade.value == None and forloop.parentloop.counter < 3 and clade.1 == "Eukaryota (domain)" %}
							<option value="{{ clade.0 }}" selected="selected">{{ clade.1 }}</option>
							{% elif form.clade.value == clade.0 %}
							<option value="{{ clade.0 }}" selected="selected">{{ clade.1 }}</option>
							{% else %}
							<option value="{{ clade.0 }}">{{ clade.1 }}</option>
							{% endif %}
							{% endfor %}
						</select>
					</div>
					<div class='my-2 db-select'>
						<select class='form-control multiselect' name="form-{{ forloop.counter0 }}-isotype" id="isotype-select-{{ forloop.counter0 }}">
							<!-- <option value="All" selected="selected">All isotypes</option> -->
							{% for isotype in form.isotype.field.choices %}
							{% if form.isotype.value == None and isotype.0 == 'All' %}
							<option value="{{ isotype.0 }}" selected="selected">{{ isotype.1 }}</option>
							{% elif form.isotype.value == isotype.0 %}
							<option value="{{ isotype.0 }}" selected="selected">{{ isotype.1 }}</option>
							{% else %}
							<option value="{{ isotype.0 }}">{{ isotype.1 }}</option>
							{% endif %}
							{% endfor %}
						</select>
					</div>

					{% if forloop.counter > 1 %}
					<button class="btn btn-sm btn-secondary switch-fasta-input">Switch to FASTA input</button>
					{% endif %}
					{% if forloop.counter > 1 and forloop.counter != 3 %}
					<button class="btn btn-sm btn-danger remove-form-row">Delete row</button>
					{% endif %}

				<!-- tag closing for IDE support -->
				{% if forloop.counter > 2 %}
				</div>
				{% elif forloop.counter == 2 %}
				</div>
				{% elif forloop.counter == 1 %}			
				</div>
				{% endif %}
		{% if forloop.last %}
				<hr class="col-md-10">
				<div class='my-2'>
          <button class="btn btn-success add-form-row">Add row</button>
					<button class='btn btn-primary' type='submit'>Submit</button>
        </div>
			</div>
		</div>
		{% elif forloop.counter == 1 %}
			</div>
		</div>
		{% endif %}
		{% endfor %}
	</form>
</div>
{% endblock %}


{% block plots %}
<div class="p-3">

	<div class="p-3" id="bitchart-area">
			<img src="http://users.soe.ucsc.edu/~blin/pub/srna-viz/bitcharts/hg19-tRNA-Ser-AGA.png" width="100%" align="center">
		<!-- <div class="loading-overlay">
		</div> -->
	</div>
</div>
{% endblock %}