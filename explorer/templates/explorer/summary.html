{% extends "base.html" %}
{% load static from staticfiles %}
{% load explorer_extras %}

{% block static %}<link rel="stylesheet" href="{% static 'explorer/css/explorer.css' %}">{% endblock %}
{% block title %}tRNAviz | Summary{% endblock %}

{% block filterjs %}
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

<script>	
$(document).ready(function() {
	$('#id_clade').select2({
		width: "100%", 
		allowClear: true, 
		placeholder: "Select reference clade", 
		minimumInputLength: 3,
	  ajax: {
	  	url: "{% url 'explorer:search' search_type='clade' %}",
    	dataType: 'json'
  	}
	});
	$('#id_isotype').select2({width: "100%", allowClear: true, placeholder: "Select an isotype"});
})
</script>
{% endblock %}


{% block plotjs %}
<script src='https://d3js.org/d3.v4.min.js'></script>
<script src="{% static 'explorer/js/consensus.js' %}"></script>
<script type = "text/javascript">
var coords_path = "{% url 'explorer:coords' %}"
d3.json('{% url "explorer:cloverleaf" clade_txid=clade_txid isotype=isotype %}', function(plot_data) {
  d3.select('#cloverleaf-area .loading-overlay').style('display', 'none');
	d3.select('#cloverleaf-base-distro-area .loading-overlay').style('display', 'none');
  if ("server_error" in plot_data) d3.select('#cloverleaf-area').text(plot_data['server_error']);
	else {
		draw_cloverleaf(plot_data);
		draw_base_distro(plot_data, 'cloverleaf');
	}
});
d3.json('{% url "explorer:tilemap" clade_txid=clade_txid %}', function(plot_data) {
  d3.select('#tilemap-area .loading-overlay').style('display', 'none');
	d3.select('#tilemap-base-distro-area .loading-overlay').style('display', 'none');
  if ("server_error" in plot_data) d3.select('#tilemap-area').text(plot_data['server_error']);
	else {
		draw_tilemap(plot_data);
		draw_base_distro(plot_data, 'tilemap');
	}
});
d3.json('{% url "explorer:taxonomy_summary" clade_txid=clade_txid isotype=isotype %}', function(table_data) {
  d3.select('#taxonomy-summary-area .loading-overlay').style('display', 'none');
  if ("server_error" in table_data) d3.select('#taxonomy-summary-area').text(table_data['server_error']);
	else {
		$('#taxonomy-summary-area').html(tax_json_to_table(table_data))
	}
});
d3.json('{% url "explorer:domain_features" clade_txid=clade_txid isotype=isotype %}', function(table_data) {
  d3.select('#domain-features-area .loading-overlay').style('display', 'none');
  if ("server_error" in table_data) d3.select('#domain-features-area').text(table_data['server_error']);
	else {
		$('#domain-features-area').html(cons_json_to_table(table_data))
	}
});

$(document).ready(function() {
	var anticodon_counts_http = new XMLHttpRequest();
	anticodon_counts_http.open('GET', '{% url "explorer:anticodon_counts" clade_txid=clade_txid isotype=isotype %}', true)
	anticodon_counts_http.send();
	anticodon_counts_http.onreadystatechange=(e)=>{
		$('#anticodon-counts-area').html(anticodon_counts_http.responseText);
	};

	var isotype_discrepancies_http = new XMLHttpRequest();
	isotype_discrepancies_http.open('GET', '{% url "explorer:isotype_discrepancies" clade_txid=clade_txid isotype=isotype %}', true)
	isotype_discrepancies_http.send();
	isotype_discrepancies_http.onreadystatechange=(e)=>{
		$('#isotype-discrepancies-area').html(isotype_discrepancies_http.responseText);
	};
})
</script>
{% endblock %}



{% block filter %}

{% if form.errors %}
<div class='alert alert-danger'>
	{% for field in form %}
		{% for error in field.errors %}
			<li>Error in {{ field.name }}: {{ error|escape }}</li>
		{% endfor %}
	{% endfor %}
</div>
{% endif %}

<div class='p-3'>
	<div class='row vertical-align select-bar data-select-bar'>
		<div class='col-md-2 p-3'>
			<h4>Select tRNAs</h4>
		</div>
		<div class='col-md-10 p-3'>

			<form id='data-select-form' action='{% url "explorer:summary" %}' method="POST">
				{% csrf_token %}
				<div class='my-2'>
					<select class='form-control multiselect clade-select' name="clade" id="id_clade">
						{% if form.clade.value != None %}
						<option value="{{ form.clade.value }}">{{ form.clade.value|clade_lookup }}</option>
						{% endif %}
					</select>
				</div>
				<div class='my-2'>
					{{ form.isotype }}
				</div>
				<div class='my-2'>
					<button class='btn btn-primary' type='submit'>Submit</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block table %}
<div class="data-select-table">
	<table class="table sticky-top">
		<thead>
			<tr>
				<th scope="col">Clade</th>
				<th scope="col">Isotype</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{{ clade }}</td>
				<td>{{ isotype }}</td>
			</tr>
		</tbody>
	</table>
</div>
{% endblock %}


{% block plots %}

<div class="plotbox-row">
	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Consensus features</h5>
		</div>
		<div class="plotbox-inner" id="cloverleaf-area">
			<div class="loading-overlay"></div>
		</div>
	</div>

	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Nucleotide distribution by position</h5>
		</div>
		<div class="plotbox-inner" id="cloverleaf-base-distro-area">
			<div class="loading-overlay"></div>
		</div>
	</div>
</div>


<div class="plotbox-row">
	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Taxonomy summary</h5>
		</div>
		<div class="table-inner" id="taxonomy-summary-area">
			<div class="loading-overlay"></div>
		</div>
	</div>

	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Domain-specific consensus features</h5>
		</div>
		<div class="table-inner" id="domain-features-area">
			<div class="loading-overlay"></div>
		</div>
	</div>

	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Anticodon counts</h5>
		</div>
		<div class="table-inner" id="anticodon-counts-area">
			<div class="loading-overlay"></div>
		</div>
	</div>

	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Isotype discrepancies</h5>
		</div>
		<div class="table-inner" id="isotype-discrepancies-area">
			<div class="loading-overlay"></div>
		</div>
	</div>
</div>


<div class="plotbox-row">
	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Consensus isotype-specific features</h5>
		</div>
		<div class="plotbox-inner" id="tilemap-area">
			<div class="loading-overlay"></div>
		</div>
	</div>

	<div class="plotbox-outer">
		<div class="plotbox-title">
			<h5>Nucleotide distribution by position / isotype</h5>
		</div>
		<div class="plotbox-inner" id="tilemap-base-distro-area">
			<div class="loading-overlay"></div>
		</div>
	</div>

</div>


{% endblock %}