{% extends "explorer/variation.html" %}
{% load static from staticfiles %}
{% load explorer_extras %}

{% block filterjs %}
{{ block.super }}
<!-- initialize filter functions -->
<script type="text/javascript">
$(document).ready(function() {
	// initialize select2 fields
	for (var i = 1, form_rows = $('.focus-form-row'); i <= form_rows.length; i++) {
		$('#id_focus-' + i + '-isotype').select2({width: "100%", allowClear: true, placeholder: "Select isotype"});
	  $('#id_focus-' + i + '-position').select2({width: "100%", allowClear: true, placeholder: "Select position"});
	  $('#id_focus-' + i + '-anticodon').select2({width: "100%", allowClear: true, placeholder: "Select anticodon"});
	}
})

// initialize score sliders 
var init_slider = function(i) {
	return function() {
		var score_range = $('#focus-' + i + '-score-slider').prev().attr('score-range').split(' - ').map(Number);
		var selected_score = $('#focus-' + i + '-score-slider').prev().attr('value').split(' - ').map(Number);
		$('#focus-' + i + '-score-slider').slider({
      range: true,
      min: score_range[0],
      max: score_range[1],
      values: selected_score,
      slide: function( event, ui ) {
        $('#id_focus-' + i + '-score').val(ui.values[0] + " - " + ui.values[1]);
      }
    });
    $('#id_focus-' + i + '-score').val($('#focus-' + i + '-score-slider').slider('values', 0) + " - " + $('#focus-' + i + '-score-slider').slider('values', 1));
	}
};

$(function() {
	for (var i = 1, form_rows = $('.focus-form-row'); i <= form_rows.length; i++) {
		init_slider(i)();
  }
});

// Functions for adding and removing foci
$(document).on('click', '.add-focus', function(e){
  e.preventDefault();
  var form_index, position_select, isotype_select, anticodon_select, score_input, score_slider;

  var add_focus_row = function () {
  	var new_form = $('.focus-form-row-dummy').clone(true).removeClass().addClass('focus-form-row').css('display', 'block');
  	var form_index = $('#id_focus-TOTAL_FORMS').val();
	  position_select = new_form.find('#id_focus-0-position');
	  position_select.attr({
	  	'name': 'focus-' + form_index + '-position',
	  	'id': 'id_focus-' + form_index + '-position'
	  });
	  isotype_select = new_form.find('#id_focus-0-isotype');
	  isotype_select.attr({
	  	'name': 'focus-' + form_index + '-isotype',
	  	'id': 'id_focus-' + form_index + '-isotype'
	  });
	  anticodon_select = new_form.find('#id_focus-0-anticodon');
		anticodon_select.attr({
	  	'name': 'focus-' + form_index + '-anticodon',
	  	'id': 'id_focus-' + form_index + '-anticodon'
	  });
	  score_input = new_form.find('#id_focus-0-score');
	  score_input.attr({
	  	'name': 'focus-' + form_index + '-score', 
	  	'id': 'id_focus-' + form_index + '-score'
	  });
	  score_slider = new_form.find('#focus-0-score-slider');
	  score_slider.attr('id', 'focus-' + form_index + '-score-slider');
	  $('#id_focus-TOTAL_FORMS').val(++form_index);
	  $('.focus-form-row:last').after(new_form);
  };

  $.when(add_focus_row()).done( function() {
  	position_select.select2({width: "100%", allowClear: true, placeholder: "Select position"});
  	isotype_select.select2({width: "100%", allowClear: true, placeholder: "Select isotype"});
  	anticodon_select.select2({width: "100%", allowClear: true, placeholder: "Select anticodon"});
  	init_slider($('#id_focus-TOTAL_FORMS').val() - 1)();
  });
});

var select2_placeholders = {
	'position': 'Select position', 
	'isotype': 'Select isotype', 
	'anticodon': 'Select anticodon'
};

$(document).on('click', '.remove-focus', function(e){
  e.preventDefault();
  $(this).closest('.focus-form-row').remove();
  var form_number = parseInt($('#id_focus-TOTAL_FORMS').val());
  $('#id_focus-TOTAL_FORMS').val(--form_number);
  // loop through all forms and update field numbering
  for (var i = 1, form_index = 2, form_rows = $('.focus-form-row'); i < form_rows.length; i++, form_index++) {
  	// Handle all fields, including score slider (using input field as an anchor)
    $(form_rows.get(i)).find(':input').each(function() {
    	if ($(this).hasClass('btn')) return true;

  		var old_number_regex = new RegExp('focus-\\d+');
      var name = $(this).attr('name').replace(old_number_regex, 'focus-' + form_index)
      var id = $(this).attr('id').replace(old_number_regex, 'focus-' + form_index)
      console.log(form_index)
      console.log(id)
      console.log($(this).attr('id'))
      $(this).attr({'name': name, 'id': id});
      if ($(this).prop('tagName') == 'SELECT') {
      	// remove and rebind select2 for select fields
      	$(this).select2("destroy");
      	$(this).attr('data-select2-id', id);
      	$(this).select2({width: "100%", allowClear: true, placeholder: select2_placeholders[name.split('-').pop()]});
      }
      else if ($(this).prop('tagName') == 'INPUT') {
      	$(this).next().attr('id', $(this).next().attr('id').replace(old_number_regex, 'focus-' + form_index));

      }
    });
  }
});

</script>
{% endblock %}


{% block plotjs %}
{{ block.super }}
<!-- draw plot with current parameters -->
<script type = "text/javascript">
d3.json('{% url "explorer:species_distribution" clade_txids=clade_groups|clade_groups_to_url_string foci=foci|foci_to_url_string %}',	function(plot_data) {
  d3.select('#distribution-area .loading-overlay').style('display', 'none');
  if ("server_error" in plot_data) d3.select('#distribution-area').text(plot_data['server_error'])
	else draw_species_distribution(plot_data)
});
</script>
{% endblock %}



{% block filter %}


{% if form.errors %}
<div class='alert alert-danger'>
	{% if form.non_field_errors %}
		{% for error in form.non_field_errors %}
			<li>Form error: {{ error|escape }}</li>
		{% endfor %}
	{% endif %}
	{% for field in form %}
		{% for error in field.errors %}
			<li>Error in field {{ field.name }}: {{ error|escape }}</li>
		{% endfor %}
	{% endfor %}
</div>
{% endif %}


<div class='p-3'>
	<form id='data-select-form' action='{% url "explorer:variation_species" %}' method="POST">
	{% csrf_token %}
	<div class='row vertical-align clade-select-bar'>
		<div class='col-md-2 p-3'>
			<h4>Select Clades</h4>
		</div>

		<div class='col-md-10 p-3'>
			{{ clade_formset.management_form }}
			{% for clade_group_form in clade_formset.forms %}
			{% if forloop.counter0 == 0 %}
			<!-- Dummy clade form row -->
			<div class='clade-form-row-dummy' style='display:none;'>
			{% else %}
			<div class='clade-form-row'>
			{% endif %}
				<div class="row">
					<div class="col-11">
						{% for field in clade_group_form.visible_fields %}
						<select class='form-control multiselect clade-select' multiple name="clade-{{ forloop.parentloop.counter0 }}-clade_group" id="id_clade-{{ forloop.parentloop.counter0 }}-clade_group" data-select2-id="id_clade-{{ forloop.parentloop.counter0 }}-clade_group">
							{% for choice in field.value %}
							<option value="{{ choice }}" selected >{{ choice|clade_lookup }}</option>
							{% endfor %}
						</select>
						{% endfor %}
					</div>
					<div class="col-1">
				  	{% if forloop.counter0 != 1 %}
						<button class="btn btn-sm btn-danger remove-clade-group">Delete</button>
				  	{% endif %}
					</div>
				</div>
			</div>
			{% endfor %}
		</div>

	</div>

	<div class='row vertical-align select-bar data-select-bar'>
		<div class='col-md-2 p-3'>
			<h4>Select Foci</h4>
		</div>

		<div class='col-md-10 p-3'>
			{{ focus_formset.management_form }}
			{% for focus_form in focus_formset.forms %}
			{% if forloop.counter0 == 0 %}
			<!-- Dummy focus form row -->
			<div class='focus-form-row-dummy' style='display:none;'>
			{% else %}
			<div class='focus-form-row'>
			{% endif %}
				<div class='row vertical-align'>
					{% for field in focus_form.visible_fields %}
					{% if field.name == 'score' %}
					<div class="col-5 focus-score">
						Score (bits): <input type="text" id="id_focus-{{ forloop.parentloop.counter0 }}-score" name="{{ field.html_name }}" readonly class="score-slider" value="{{ field.value }}" score-range="{% score_range %}">
				  	<div id="{{ field.html_name }}-slider"></div>
					</div>
					{% else %}
					{% if field.name == 'anticodon' %}
					<div class='col-2 focus-anticodon'>
						{{ field }}
					</div>
					{% else %}
					<div class='col-2 focus-{{ field.name }}'>
						{{ field }}
					</div>
					{% endif %}
					{% endif %}
					{% endfor %}
					{% if forloop.counter0 != 1 %}
				  <div class="col-1">
						<button class="btn btn-sm btn-danger remove-focus">Delete</button>
				  </div>
				  {% endif %}
				</div>
				<hr class="col-md-10">
			</div>
			{% endfor %}
			<div class='my-2'>
				<button class="btn btn-success add-clade-group">Add clade group</button>
		    <button class="btn btn-success add-focus">Add focus</button>
				<button class='btn btn-primary' type='submit'>Submit</button>
			</div>
		</div>
	</div>
  </form>
</div>
{% endblock %}

{% block table %}
<div class="data-select-table">
	<table class="table sticky-top">
		<tr>
			<th scope="row">Clade groups</th>
			<td colspan="5">{{ clade_group_names|clade_names_to_pretty_string|linebreaks }}</td>
		</tr>
		<tr>
			<th scope="col" rowspan="5">Foci</th>
			<th scope="col">Position</th>
			<th scope="col">Isotype</th>
			<th scope="col">Anticodon</th>
			<th scope="col">Score range</th>
		</tr>
		{% for focus in foci %}
		<tr>
			<td>{{ focus|focus_value:'position' }}</td>
			<td>{{ focus|focus_value:'isotype' }}</td>
			<td>{{ focus|focus_value:'anticodon' }}</td>
			<td>{{ focus|focus_value:'score' }}</td>
		</tr>
		{% endfor %}
	</table>
</div>
{% endblock %}